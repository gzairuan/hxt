var rootPath = util.getRootPath();

var table = $('#tableSchoolNotice');
    	
//查询条件：开始日期
$('#startDate').datetimepicker({
    format: 'yyyy-mm-dd', //日期格式
    language: 'zh-CN', // 国际化 为中文
    startDate: "2013-02-14 10:00", //开始日期格式
    minView: 2, // 精确到2天
    todayBtn: true, //显示当天日期
    autoclose: true //选择日期后自动关闭 
});

//查询条件： 结束日期
$('#endDate').datetimepicker({
    format: 'yyyy-mm-dd', //日期格式
    language: 'zh-CN', // 国际化 为中文
    startDate: "2013-02-14 10:00", //开始日期格式
    minView: 2, // 精确到2天
    todayBtn: true, //显示当天日期
    autoclose: true //选择日期后自动关闭 
});
    	
$(function(){
	//初始化table信息
	tableInit();
});
    	
//table 信息初始化
function tableInit(){
   table.bootstrapTable({
        url:rootPath+'/noticeServlet?optFlag=query',//远程请求地址
        method:'post',//请求方式
        type: 'json', //数据类型 
        contentType: "application/x-www-form-urlencoded",//请求数据类型('post'必须设置)
        striped: true,      //是否显示行间隔色
        toolbar: "#toolbar",  //一个jQuery 选择器，指明自定义的toolbar 例如:#toolbar, .toolbar.
        cache: false,      //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
        sortable: false,      //是否启用排序
        pagination: true,     //是否显示分页（*）
        pageNumber:1,      //初始化加载第一页，默认第一页
        pageSize: 10,      //每页的记录行数（*）
        pageList: [10, 25, 50],  //可供选择的每页的行数（*）
        sidePagination: "server",   //分页方式：client客户端分页，server服务端分页（*）
        clickToSelect: true,    //是否启用点击选中行
        uniqueId:'NOTICEID',	//每一行的标识（要具有唯一性）
        queryParams: queryParams, //定义请求参数
        columns: [
            //field对应返回数据中的字段
            {field:'NEWSTITLE', title:'消息标题'},
            {field:'CONTENT', title: '消息内容', width:'38%'},
            {field:'USERNAME', title: '发布人'},
            {field: 'CRETIME', title: '发布时间',
				formatter:function (value, row, index){
					var time = value.replace('T',' ');
					return time;
				}
            },
            {title:'操作',align:'center', width:'18%',
                formatter:function (value, row, index) {
					//获取当前row内容
                    var id = row.NOTICEID;
                    return [
                            '<a type="button" class="btn btn-primary shiny btn-xs purple" data-id="'+id+'" data-toggle="modal" data-target="#addModal" data-flag="edit"><i class="fa fa-edit"></i>&nbsp;编辑</a>&nbsp',
                    		'<a type="button" class="btn btn-info shiny btn-xs purple" data-id="'+id+'" data-toggle="modal" data-target="#detailModal"><i class="fa fa-eye"></i>&nbsp;查看</a>&nbsp',
                            '<a type="button" class="btn btn-danger shiny btn-xs purple" onclick="confirmDeleteModal('+id+')" data-toggle="modal" data-target="#deleteModal"><i class="fa fa-trash-o"></i>&nbsp;删除</a>&nbsp'
                        ].join('');
                }
            }
        ],
        onClickRow:function(row,ele,fileid){//table选中行设置背景色
        	$(".info").removeClass("info");
        	$(ele).addClass("info");
        }
    });
};

//定义请求传参集合 ,学校通知类型为1
var searchData = {typeId: "1"};
//给请求参数赋值
function queryParams(params){
	params.typeId = searchData.typeId;
	params.startDate = searchData.startDate;
	params.endDate = searchData.endDate;
	params.keyword = searchData.keyword;
	return params;
};
        
// 查询条件参数赋值
function queryData() {
	searchData.startDate = $('#startDate').val();
	searchData.endDate = $('#endDate').val();
	searchData.keyword = $('#keyword').val();
	console.info("satrt:" + $('#startDate').val());
	table.bootstrapTable('destroy');
	// 重新创建表格 用于重新加载数据
	tableInit();
};
        
// 弹出modal时根据flag标记判断是否做新增或是修改操作
$('#addModal').on('show.bs.modal', function(event){
	var button = $(event.relatedTarget); //获取触发事件目标按钮
	var flag = button.data("flag"); //获取操作标识符
	var modal = $(this);
	var btnSave = $('#btnSave');
	
	if(flag == "add"){//新增操作
//         		console.info("新增操作222");
		modal.find('.modal-title').text("新增学校通知"); //设置modal标题
		$('#addForm')[0].reset(); //清空form表单
		btnSave.removeAttr('onclick');
		btnSave.attr('onclick', 'addSchoolNotice()');
	}else{//修改操作
		modal.find('.modal-title').text("修改学校通知"); //设置modal标题
		var id = button.data('id'); // Extract info from data-* attributes
		//获取UniqueId标识的行数据
		var row = table.bootstrapTable('getRowByUniqueId', id);
		
		$('#newsTitle').val(row.NEWSTITLE);
		$('#newsContent').val(row.CONTENT);
		//移除点击事件
		btnSave.removeAttr("onclick");
		//添加编辑事件
		btnSave.attr('onclick','editSubmit('+id+')');
	}
});

$('#addModal').on("hidden.bs.modal", function() {
	$('#addForm').bootstrapValidator('resetForm', true);  //重置验证
});
        
/* 图片处理 ，初始化上传文件框 */
$('#selectImgId').fileinput({
	language : 'zh', // 设置语言
	uploadUrl : rootPath+'/noticImgUploadFile?optFlag=schoolnotice', // 上传的地址
	// 设置预览图片大小
	showPreview : true, // 是否显示预览
	showBrowse : true,
	showUpload : true, // 是否显示上传按钮
	showRemove : true, // 显示移除按钮
	showCaption : false,// 是否显示标题
	showCancel : true,
	browseClass : "btn btn-info", // 按钮样式
	maxFileCount : 9,/* 允许最大上传数，可以多个，当前设置9个 */
	msgFilesTooMany : "最多只能上传9张图片",
	dropZoneTitle : "请通过拖拽图片文件放到这里",
	dropZoneClickTitle : "或者点击此区域添加图片",
	browseOnZoneClick : true,
	fileActionSettings : {// 上传图片动作
		showUpload : false, // 上传
		showZoom : false, // 预览
		showDrag : false // 拖拽
	},
	/*layoutTemplates : {
		progress : ""
	},*/
	// elErrorContainer: "",
	// msgErrorClass: "",//上传错误信息显示
	allowedFileExtensions : [ 'jpg', 'png', 'jpeg' ],// 上传文件格式
	overwriteInitial : false,
	maxFileSize : 1024, // 上传文件大小
	maxFilesNum : 9, // 上传文件最大个数
	msgFilesTooMany : "最大只能上传9张图片", // 上传文件超过最大值提示
	initialCaption : "选择上传图片", // 文本框初始话value
	removeFromPreviewOnError : false,
	slugCallback : function(filename) {// 处理空格
		return filename.replace('(', '_').replace(']', '_');
	},
	uploadExtraData : function(previewId, index) { // 额外参数的关键点
		var obj = {};
		return obj;
	}
});

/* 点击图片上传 显示或隐藏 fileinput 组件 */
function add_img(){
	var uploadImgId = $('#uploadImgId');
	var selectImgDiv = $('#selectImgDiv');
	var selectImgId = $('#selectImgId');
	var inputValue = uploadImgId.val();
	
	if(inputValue == "上传图片"){//点击时显示或隐藏图片上传组件
		uploadImgId.val("隐藏图片");
    	selectImgDiv.removeAttr('style');
    	selectImgDiv.css('display', 'true');
	}else{
		uploadImgId.val("上传图片");
		selectImgDiv.removeAttr('style');
		selectImgDiv.css('display', 'none');
	}
};

/* 表单验证 */
$('#addForm').bootstrapValidator({
	fields : {
		title : {
			validators : {
				notEmpty : {
					message : '请填写标题'
				}
			}
		},content : {
			validators : {
				notEmpty : {
					message : '请填写内容'
				}
			}
		}
	},
	excluded: [':disabled']
});

//新增学校通知 提交时方法
function addSchoolNotice(){
	var fileCount = $('#selectImgId').fileinput('getFilseCount');
	console.info(fileCount);
	if(fileCount>0){
		//选择图片，在表单提交时执行图片上传按钮，把图片上传到服务器端
		$('#selectImgId').fileinput('upload');	
		var arr = [];
		//上传图片成功后执行回调函数 filebatchuploadsuccess fileuploaded
		$("#selectImgId").on("fileuploaded", function(event, data, previewId, index) {
			if(data.response){
				var response= data.response, 
				files = data.files, 
				filenames = data.filenames, //上传文件名
				servicePath = response[0].uploadUrl;
				
				var path = servicePath+"/";
				var imgUrl = '';
				
				if(index == 0){
					$.each(filenames, function(i, item){ //遍历获取文件名
						imgUrl += 'imgUrl=' + path + filenames[i]+"&";
					});
					// 保存表单数据到数据库
//        		debugger;
					addNoticeToService(imgUrl);
				}
			}
		});  //end fileuploaded
	}else{
		addNoticeToService('');
	}
};

/* 把数据添加到数据库 */
function addNoticeToService(imgUrl){
	var $form = $('#addForm');
	var valid = $form.data('bootstrapValidator');
	valid.validate();  
	if(valid.isValid()){
		$.ajax({
			url:rootPath+'/noticeServlet?optFlag=add',
			data: $form.serialize()+"&typeId=1" + "&"+imgUrl,
			dataType:'json',
			success: function(data){
				if(data.result == "ok"){
					toastr.success('新增成功', '提示');
					table.bootstrapTable('refresh');
					$('#selectImgId').fileinput('refresh');//刷新fileinput  
				}else{
					toastr.error('新增失败!请稍后再试 ', '提示');
				}
			}
		});
		$('#addModal').modal('hide');//隐藏modal 
	}
}

//修改实现方法
function editSubmit(id){
	var valid = $('#addForm').data('bootstrapValidator');
	valid.validate();  
	if(valid.isValid()){
		//获取UniqueId标识的行数据
		var title = $('#newsTitle').val();
		var content = $('#newsContent').val();
		
		var row = table.bootstrapTable('getRowByUniqueId', id);
		row.NEWSTITLE = title;
		row.CONTENT = content;
	//         	console.info(JSON.stringify(row));
		$.ajax({
			url:rootPath+'/noticeServlet?optFlag=edit',
			data:{
	            "notice": JSON.stringify(row),
	            "typeId":"1" //学校通知
	        },
	        dataType:'json',
			success: function(data){
				if(data.result == "ok"){
					toastr.success('修改成功', '提示');
					table.bootstrapTable('refresh');
				}else{
					toastr.error('修改失败!请稍后再试 ', '提示');
				}
			}
		});
		$('#addModal').modal('hide'); 
	}
};
        
// 学校通知详情
$('#detailModal').on('show.bs.modal', function(event) {
	var button = $(event.relatedTarget); // Button that triggered the modal
	var id = button.data('id'); // Extract info from data-* attributes
	//获取UniqueId标识的行数据
	var row = table.bootstrapTable('getRowByUniqueId', id);

	//填充input 内容 
	$(".notice-title").val(row.NEWSTITLE);
	$(".issuer").val(row.USERNAME);
	$(".release-time").val(row.CRETIME);
	$(".notice-content").val(row.CONTENT);
});

/*table 删除按钮*/
function confirmDeleteModal(id){
	var btnDel = $('#btnDel');
	btnDel.removeAttr("onclick");
	btnDel.attr('onclick', 'deleteData(' + id + ')');
};     
        
/*modal 确认删除按钮*/
function deleteData(id) {
	$.ajax({
		url : rootPath+"/noticeServlet?optFlag=delete",
		data : {
			"noticeId" : id,
			"typeId" : "1"
		},
		dataType:'json',
		success : function(data) {
			if(data.result == "ok"){
				toastr.success('删除成功', '提示');
				table.bootstrapTable('refresh'); //刷新表格
			}else{
				toastr.error('删除失败!请稍后再试 ', '提示');
			}
		}
	});
};
        
        